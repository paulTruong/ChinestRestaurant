<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<!-- Always force latest IE rendering engine (even in intranet) & Chrome Frame
		Remove this if you use the .htaccess -->
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
		<title>staffRoster</title>
		<!--Note that in django when you use %static% it first looks in yourApp/static
		and then in the STATICFILES_DIRS  defined in settings-->
		{% load staticfiles %}
		<link rel='stylesheet' type='text/css' href="{% static 'staffRosterApp/fullcalendar/fullcalendar.css' %}" />
		<link rel='stylesheet' type='text/css' href="{% static 'staffRosterApp/fullcalendar/fullcalendar.print.css' %}" media='print' />

		<script type='text/javascript' src="{% static 'staffRosterApp/jquery/jquery-1.9.1.min.js' %}"></script>
		<script type='text/javascript' src="{% static 'staffRosterApp/jquery/jquery-ui-1.10.2.custom.min.js' %}"></script>
		<script type='text/javascript' src="{% static 'staffRosterApp/fullcalendar/fullcalendar.min.js' %}"></script>

		<script>
			// Sample code taken from full calendar documentation and modified
			$(document).ready(function() {
			
			// Security block to prevent cross site forgery
		 $(function () {
				csrftoken =  document.getElementsByName('csrfmiddlewaretoken')[0].value
		        $.ajaxSetup({
		            headers: { "X-CSRFToken": csrftoken }
		    });
		});



				/* initialize the external events
				 -----------------------------------------------------------------*/

				$('#external-events div.external-event').each(function() {

					// create an Event Object (http://arshaw.com/fullcalendar/docs/event_data/Event_Object/)
					// it doesn't need to have a start or end
					var eventObject = {
						title : $.trim($(this).text()) , // use the element's text as the event title
					};

					// store the Event Object in the DOM element so we can get to it later
					$(this).data('eventObject', eventObject);

					// make the event draggable using jQuery UI
					$(this).draggable({
						zIndex : 999,
						revert : true, // will cause the event to go back to its
						revertDuration : 0 //  original position after the drag
					});

				});

				/* initialize the calendar
				 -----------------------------------------------------------------*/

				$('#calendar').fullCalendar({
					header : {
						left : 'prev,next today',
						center : 'title',
						right : 'agendaWeek,agendaDay'
					},
					// events: {{ eventsDictionary }},
					defaultView : 'agendaWeek',
					editable : true,
					droppable : true, // this allows things to be dropped onto the calendar !!!
					drop : function(date, allDay) {// this function is called when something is dropped

						// retrieve the dropped element's stored Event Object
						var originalEventObject = $(this).data('eventObject');

						// we need to copy it, so that multiple events don't have a reference to the same object
						var copiedEventObject = $.extend({}, originalEventObject);

				
						// assign it the date that was reported
						var startDate = new Date(date);  //Copy passed in date
						//TODO FORMAT DATE SO IT PASSES  VALIDATION + MEETS DU
						copiedEventObject.start = startDate;			
						copiedEventObject.end = new Date(startDate.setHours(startDate.getHours()+1)); //
						copiedEventObject.allDay = false;  // No requirement for all day events 
						
						

						// render the event on the calendar
						// the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
						$('#calendar').fullCalendar('renderEvent', copiedEventObject, true);

						//TODO REMOVE ME
						// is the "remove after drop" checkbox checked?
						if ($('#drop-remove').is(':checked')) {
							// if so, remove the element from the "Draggable Events" list
							$(this).remove();
						}

						// Store the new event in plain object
						alert('before the ajax ');
						//TODO some logic to save to DB
						$.ajax({
							type : "POST",
							url : "/roster/updateRoster/",											
							data : {staffName :copiedEventObject.title ,
									allDay : copiedEventObject.allDay,
									start : copiedEventObject.start ,
									end : copiedEventObject.end},

							success : function(data) {
								alert("Congratulations! AJAX WORKS!");
							},
							error : function(XMLHttpRequest, textStatus, errorThrown) {
								alert("Ajax failed again...");
								alert (errorThrown)
							}, 
						});
						alert('after the ajax ');
						//Prevent further form processing and screen reload
						return false;

					}
				});

			});

		</script>
		<style>
			body {
				margin-top: 40px;
				text-align: center;
				font-size: 14px;
				font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
			}

			#wrap {
				width: 1100px;
				margin: 0 auto;
			}

			#external-events {
				float: left;
				width: 150px;
				padding: 0 10px;
				border: 1px solid #ccc;
				background: #eee;
				text-align: left;
			}

			#external-events h4 {
				font-size: 16px;
				margin-top: 0;
				padding-top: 1em;
			}

			.external-event {/* try to mimick the look of a real event */
				margin: 10px 0;
				padding: 2px 4px;
				background: #3366CC;
				color: #fff;
				font-size: .85em;
				cursor: pointer;
			}

			#external-events p {
				margin: 1.5em 0;
				font-size: 11px;
				color: #666;
			}

			#external-events p input {
				margin: 0;
				vertical-align: middle;
			}

			#calendar {
				float: right;
				width: 900px;
			}

		</style>
	</head>

	<body>
		<div id='wrap'>

			<div id='external-events'>
				<h4>Draggable Events</h4>
				<div class='external-event'>
					manager00
				</div>
				<div class='external-event'>
					Bob james
				</div>
				<div class='external-event'>
					Mr Anderson
				</div>
				<div class='external-event'>
					Fuzzy
				</div>
				<div class='external-event'>
					Lilu
				</div>
				<p>
					<input type='checkbox' id='drop-remove' />
					<label for='drop-remove'>remove after drop</label>
				</p>
			</div>
			{% csrf_token %}
			<div id='calendar'></div>

			<!-- <div style='clear:both'></div> -->
		</div>
	</body>
</html>
